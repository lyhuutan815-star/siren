<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èµ„æºå¯¼èˆª</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --card-bg: rgba(255, 255, 255, 0.08);
            --card-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --accent: #4facfe;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text);
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 420px;
        }

        /* å¤´éƒ¨ - ä¹Ÿå°±æ˜¯ç§˜å¯†å¼€å…³ */
        .header { margin: 40px 0; text-align: center; cursor: default; }
        .avatar {
            width: 80px; height: 80px;
            background: linear-gradient(45deg, #00f2fe 0%, #4facfe 100%);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 35px; margin: 0 auto 15px;
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.4);
            transition: transform 0.2s;
            user-select: none;
        }
        .avatar:active { transform: scale(0.95); }

        .link-list { display: flex; flex-direction: column; gap: 15px; }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 16px;
            display: flex; align-items: center;
            text-decoration: none;
            color: white;
            transition: all 0.3s;
            position: relative;
        }

        .card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.15); }

        .card-icon { font-size: 24px; margin-right: 15px; width: 40px; text-align: center; }
        .card-info { flex: 1; overflow: hidden; }
        .card-title { font-weight: bold; margin-bottom: 4px; }
        .card-url { font-size: 12px; opacity: 0.6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .tag {
            position: absolute; top: 0; right: 0;
            background: #ff4757; font-size: 10px; padding: 2px 8px;
            border-bottom-left-radius: 8px; border-top-right-radius: 16px;
        }

        /* ç¼–è¾‘æ¨¡å¼ä¸‹çš„æ ·å¼ */
        .edit-mode .card { border-color: var(--accent); border-style: dashed; }
        .admin-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px;
            display: flex; gap: 10px; backdrop-filter: blur(10px); z-index: 99;
        }
        .btn { padding: 8px 16px; border-radius: 20px; border: none; font-size: 12px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-danger { background: #ff4757; color: white; }

        /* æ¨¡æ€æ¡† */
        .modal-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .modal { background: #2d3436; padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; }
        .input { width: 100%; padding: 10px; margin: 5px 0 15px; background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; border-radius: 8px; }
    </style>
</head>
<body>

<div id="app" class="container" :class="{ 'edit-mode': isAdmin }">
    
    <!-- å¤´éƒ¨ï¼šè¿™é‡Œè—ç€ç§˜å¯†å¼€å…³ -->
    <!-- è¿ç»­ç‚¹å‡»å¤´åƒ 5 æ¬¡ï¼Œå”¤å‡ºç®¡ç†å‘˜ç™»å½• -->
    <div class="header">
        <div class="avatar" @click="triggerAdminLogin">ğŸš€</div>
        <h2>èµ„æºå¯¼èˆª</h2>
        <p v-if="loading" style="font-size: 12px; opacity: 0.7; margin-top: 10px;">åŠ è½½ä¸­...</p>
    </div>

    <!-- åˆ—è¡¨åŒºåŸŸ -->
    <div class="link-list">
        <div v-for="(link, index) in sortedLinks" :key="index">
            <!-- æ™®é€šç”¨æˆ·çœ‹åˆ°çš„ï¼šç‚¹å‡»è·³è½¬ -->
            <a v-if="!isAdmin" :href="link.url" target="_blank" class="card">
                <div v-if="link.tag" class="tag">{{ link.tag }}</div>
                <div class="card-icon">{{ link.icon || 'ğŸ”—' }}</div>
                <div class="card-info">
                    <div class="card-title">{{ link.title }}</div>
                    <div class="card-url">{{ link.url }}</div>
                </div>
            </a>

            <!-- ç®¡ç†å‘˜çœ‹åˆ°çš„ï¼šç‚¹å‡»ç¼–è¾‘ -->
            <div v-else class="card" @click="openEdit(link, index)" style="cursor: pointer">
                <div class="tag" style="background:var(--accent)">ç¼–è¾‘</div>
                <div class="card-icon">{{ link.icon || 'ğŸ”—' }}</div>
                <div class="card-info">
                    <div class="card-title">{{ link.title }}</div>
                    <div class="card-url">{{ link.url }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜åº•éƒ¨å·¥å…·æ  -->
    <div v-if="isAdmin" class="admin-bar">
        <button class="btn btn-primary" @click="openAdd">+ æ·»åŠ </button>
        <button class="btn btn-danger" @click="logout">é€€å‡ºåå°</button>
    </div>

    <!-- ç™»å½•å¼¹çª— (ä»…åœ¨è§¦å‘ç§˜å¯†å¼€å…³æ—¶æ˜¾ç¤º) -->
    <div v-if="showLoginModal" class="modal-mask">
        <div class="modal">
            <h3>ğŸ›¡ï¸ ç®¡ç†å‘˜è®¤è¯</h3>
            <p style="font-size: 12px; opacity: 0.7; margin-bottom: 10px;">è¯·è¾“å…¥ JSONBin Master Key</p>
            <input v-model="inputKey" type="password" class="input" placeholder="X-Master-Key">
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1" @click="showLoginModal=false">å–æ¶ˆ</button>
                <button class="btn btn-primary" style="flex:1" @click="verifyAdmin">ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘/æ·»åŠ å¼¹çª— -->
    <div v-if="showEditModal" class="modal-mask">
        <div class="modal">
            <h3>{{ isEditing ? 'ç¼–è¾‘' : 'æ·»åŠ ' }}</h3>
            <input v-model="form.title" class="input" placeholder="æ ‡é¢˜">
            <input v-model="form.url" class="input" placeholder="ç½‘å€">
            <div style="display:flex; gap:10px">
                <input v-model="form.icon" class="input" placeholder="å›¾æ ‡Emoji">
                <input v-model="form.tag" class="input" placeholder="æ ‡ç­¾">
            </div>
            <input v-model.number="form.order" type="number" class="input" placeholder="æ’åºæƒé‡">
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn" style="flex:1" @click="showEditModal=false">å–æ¶ˆ</button>
                <button v-if="isEditing" class="btn btn-danger" @click="deleteItem">åˆ é™¤</button>
                <button class="btn btn-primary" style="flex:1" @click="saveItem">{{ saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜' }}</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // ==========================================
            // ğŸ”´ å…³é”®é…ç½®ï¼šè¯·åœ¨è¿™é‡Œå¡«å…¥æ‚¨çš„ BIN ID
            // è¿™æ ·è¿™ä¸ªç½‘é¡µå°±åªèƒ½åŠ è½½æ‚¨çš„æ•°æ®äº†
            const BIN_ID = "69511adb03998b11ea8db005"; 
            // ==========================================

            const links = ref([]);
            const loading = ref(true);
            const saving = ref(false);
            
            // ç®¡ç†å‘˜ç›¸å…³çŠ¶æ€
            const isAdmin = ref(false);
            const showLoginModal = ref(false);
            const inputKey = ref("");
            const masterKey = ref(localStorage.getItem('nav_master_key') || "");
            
            // ç§˜å¯†è§¦å‘å™¨è®¡æ•°
            const clickCount = ref(0);
            let clickTimer = null;

            // ç¼–è¾‘ç›¸å…³
            const showEditModal = ref(false);
            const isEditing = ref(false);
            const editIndex = ref(-1);
            const form = ref({});

            const sortedLinks = computed(() => {
                // å¦‚æœæ•°æ®æ ¼å¼ä¸å¯¹ï¼Œè¿”å›ç©ºæ•°ç»„é˜²æ­¢æŠ¥é”™
                if(!Array.isArray(links.value)) return [];
                return [...links.value].sort((a, b) => (a.order || 0) - (b.order || 0));
            });

            // 1. è·å–æ•°æ® (å…¬å¼€è¯»å–ï¼Œä¸éœ€è¦Key)
            const fetchData = async () => {
                if(BIN_ID === "YOUR_BIN_ID_HERE") {
                    alert("âš ï¸ ä¸¥é‡é”™è¯¯ï¼šæ‚¨å¿˜è®°ä¿®æ”¹ä»£ç ä¸­çš„ BIN_ID äº†ï¼\n\nè¯·æ‰“å¼€ä»£ç æ–‡ä»¶ï¼Œæ‰¾åˆ°ç¬¬ 230 è¡Œå·¦å³ï¼ŒæŠŠ 'YOUR_BIN_ID_HERE' æ›¿æ¢æˆæ‚¨åœ¨ JSONBin ç½‘ç«™ä¸Šè·å–çš„ Bin IDã€‚");
                    return;
                }
                try {
                    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                        headers: { 'X-Bin-Meta': 'false' }
                    });
                    if(!res.ok) throw new Error("è¯»å–å¤±è´¥");
                    const data = await res.json();
                    links.value = Array.isArray(data) ? data : (data.record || []);
                } catch (e) {
                    console.error(e);
                    // ä»…æç¤ºä¸€æ¬¡
                } finally {
                    loading.value = false;
                }
            };

            // 2. ç§˜å¯†è§¦å‘é€»è¾‘
            const triggerAdminLogin = () => {
                // å·²ç»ç™»å½•äº†å°±ä¸ç”¨è§¦å‘äº†
                if (isAdmin.value) return;

                clickCount.value++;
                // 1ç§’å†…å¿…é¡»ç‚¹ä¸‹ä¸€æ¬¡ï¼Œå¦åˆ™é‡ç½®
                clearTimeout(clickTimer);
                clickTimer = setTimeout(() => { clickCount.value = 0; }, 1000);

                // è¿ç»­ç‚¹å‡» 5 æ¬¡å”¤å‡ºç™»å½•æ¡†
                if (clickCount.value >= 5) {
                    showLoginModal.value = true;
                    clickCount.value = 0;
                }
            };

            // 3. éªŒè¯ç®¡ç†å‘˜ (å…¶å®å°±æ˜¯ä¿å­˜Key)
            const verifyAdmin = () => {
                if (inputKey.value.length < 10) {
                    alert("Key æ ¼å¼çœ‹èµ·æ¥ä¸å¯¹");
                    return;
                }
                masterKey.value = inputKey.value;
                localStorage.setItem('nav_master_key', inputKey.value);
                isAdmin.value = true;
                showLoginModal.value = false;
                alert("ç®¡ç†å‘˜æ¨¡å¼å·²å¼€å¯");
            };

            // 4. ä¿å­˜æ•°æ® (éœ€è¦Key)
            const syncCloud = async () => {
                if(BIN_ID === "YOUR_BIN_ID_HERE") {
                    alert("ä¿å­˜å¤±è´¥ï¼šæ‚¨è¿˜æ²¡ä¿®æ”¹ä»£ç ä¸­çš„ BIN_IDï¼è¯·ä¿®æ”¹åå†è¯•ã€‚");
                    return;
                }

                saving.value = true;
                try {
                    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': masterKey.value
                        },
                        body: JSON.stringify(links.value)
                    });

                    if(!res.ok) {
                        const errData = await res.json().catch(()=>({}));
                        console.error("Save Error:", res.status, errData);

                        if(res.status === 401 || res.status === 403) {
                            alert(`âŒ ä¿å­˜å¤±è´¥ (é”™è¯¯ç  ${res.status})\n\nåŸå› ï¼šKey ä¸æ­£ç¡®æˆ–æƒé™ä¸è¶³ã€‚\nè¯·æ£€æŸ¥æ‚¨è¾“å…¥çš„ Master Key æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è€…è¯¥ Bin ID æ˜¯å¦å±äºè¿™ä¸ª Keyã€‚`);
                            // æš‚æ—¶ä¸è‡ªåŠ¨ç™»å‡ºï¼Œè®©ç”¨æˆ·æœ‰æœºä¼šå»æ£€æŸ¥ Key
                        } else if(res.status === 404) {
                            alert(`âŒ ä¿å­˜å¤±è´¥ (é”™è¯¯ç  404)\n\nåŸå› ï¼šBin ID ä¸å­˜åœ¨ã€‚\nè¯·æ£€æŸ¥ä»£ç ä¸­çš„ BIN_ID æ˜¯å¦å¡«é”™äº†ã€‚`);
                        } else {
                            alert(`âŒ ä¿å­˜å¤±è´¥ (é”™è¯¯ç  ${res.status})\n\nåŸå› ï¼š${errData.message || 'æœªçŸ¥é”™è¯¯'}`);
                        }
                    } else {
                        // ä¿å­˜æˆåŠŸï¼Œåˆ·æ–°ä¸€ä¸‹æ˜¾ç¤º
                        alert("âœ… ä¿å­˜æˆåŠŸï¼");
                    }
                } catch (e) {
                    alert("ç½‘ç»œé”™è¯¯ï¼š" + e.message);
                } finally {
                    saving.value = false;
                }
            };

            // æ“ä½œé€»è¾‘
            const logout = () => {
                isAdmin.value = false;
                // å¯é€‰ï¼šæ˜¯å¦æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ keyï¼Ÿä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œæš‚ä¸æ¸…é™¤
                // localStorage.removeItem('nav_master_key');
            };

            const openAdd = () => {
                isEditing.value = false;
                form.value = { title: '', url: 'http://', order: Date.now() };
                showEditModal.value = true;
            };

            const openEdit = (item, index) => {
                isEditing.value = true;
                editIndex.value = index;
                form.value = { ...item };
                showEditModal.value = true;
            };

            const saveItem = async () => {
                const newItem = { ...form.value };
                
                // ç®€å•æ›´æ–°é€»è¾‘
                if(isEditing.value) {
                    // åŒæ ·ï¼Œå› ä¸ºæ’åºé—®é¢˜ï¼Œè¿™é‡Œç”¨æœ€ç®€å•çš„å…¨é‡æ›¿æ¢æ³•
                    // å®é™…é¡¹ç›®ä¸­å»ºè®®ç»™ item åŠ å”¯ä¸€ id
                    const target = sortedLinks.value[editIndex.value];
                    const realIndex = links.value.indexOf(target);
                    if(realIndex !== -1) links.value[realIndex] = newItem;
                } else {
                    links.value.push(newItem);
                }
                
                await syncCloud();
                showEditModal.value = false;
            };

            const deleteItem = async () => {
                if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
                const target = sortedLinks.value[editIndex.value];
                const realIndex = links.value.indexOf(target);
                if(realIndex !== -1) links.value.splice(realIndex, 1);
                
                await syncCloud();
                showEditModal.value = false;
            };

            onMounted(() => {
                fetchData();
                // è‡ªåŠ¨æ£€æŸ¥æ˜¯å¦ä»¥å‰ç™»å½•è¿‡
                if (masterKey.value) {
                    isAdmin.value = true;
                }
            });

            return {
                links, loading, saving, isAdmin, showLoginModal, inputKey,
                showEditModal, isEditing, form, sortedLinks,
                triggerAdminLogin, verifyAdmin, logout, 
                openAdd, openEdit, saveItem, deleteItem
            };
        }
    }).mount('#app');
</script>
</body>
</html>

